generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PixKeyStatus {
  ACTIVE
  INACTIVE
}

enum PixQueryAttemptResult {
  SUCCESS
  FAILED
  RATE_LIMITED
}

enum ParticipantCategory {
  A
  B
  C
  D
  E
  F
  G
  H
}

enum DictScopeType {
  USER
  PSP
}

enum DictPolicyCode {
  ENTRIES_READ_USER_ANTISCAN
  ENTRIES_READ_USER_ANTISCAN_V2
  ENTRIES_READ_PARTICIPANT_ANTISCAN
  ENTRIES_STATISTICS_READ
  ENTRIES_WRITE
  ENTRIES_UPDATE
  CLAIMS_READ
  CLAIMS_WRITE
  CLAIMS_LIST_WITH_ROLE
  CLAIMS_LIST_WITHOUT_ROLE
  SYNC_VERIFICATIONS_WRITE
  CIDS_FILES_WRITE
  CIDS_FILES_READ
  CIDS_EVENTS_LIST
  CIDS_ENTRIES_READ
  INFRACTION_REPORTS_READ
  INFRACTION_REPORTS_WRITE
  INFRACTION_REPORTS_LIST_WITH_ROLE
  INFRACTION_REPORTS_LIST_WITHOUT_ROLE
  KEYS_CHECK
  REFUNDS_READ
  REFUNDS_WRITE
  REFUND_LIST_WITH_ROLE
  REFUND_LIST_WITHOUT_ROLE
  FRAUD_MARKERS_READ
  FRAUD_MARKERS_WRITE
  FRAUD_MARKERS_LIST
  PERSONS_STATISTICS_READ
  POLICIES_READ
  POLICIES_LIST
  EVENT_LIST
}

enum DictOperation {
  GET_ENTRY
  GET_ENTRY_STATISTICS
  CREATE_ENTRY
  DELETE_ENTRY
  UPDATE_ENTRY
  GET_CLAIM
  CREATE_CLAIM
  ACKNOWLEDGE_CLAIM
  CANCEL_CLAIM
  CONFIRM_CLAIM
  COMPLETE_CLAIM
  LIST_CLAIMS
  CREATE_SYNC_VERIFICATION
  CREATE_CID_SET_FILE
  GET_CID_SET_FILE
  LIST_CID_SET_EVENTS
  GET_ENTRY_BY_CID
  GET_INFRACTION_REPORT
  CREATE_INFRACTION_REPORT
  ACKNOWLEDGE_INFRACTION_REPORT
  CANCEL_INFRACTION_REPORT
  CLOSE_INFRACTION_REPORT
  UPDATE_INFRACTION_REPORT
  LIST_INFRACTION_REPORTS
  CHECK_KEYS
  GET_REFUND
  CREATE_REFUND
  CANCEL_REFUND
  CLOSE_REFUND
  LIST_REFUNDS
  GET_FRAUD_MARKER
  CREATE_FRAUD_MARKER
  CANCEL_FRAUD_MARKER
  LIST_FRAUD_MARKERS
  GET_PERSON_STATISTICS
  GET_BUCKET_STATE
  LIST_BUCKET_STATES
  LIST_EVENT_NOTIFICATIONS
}

enum DictKeyType {
  EMAIL
  PHONE
  CPF
  CNPJ
  EVP
}

model Tenant {
  id                    String               @id @default(uuid())
  name                  String
  tokenHash             String               @unique
  participantCode       String               @unique @default(uuid())
  participantCategory   ParticipantCategory  @default(H)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  leakyBucket           LeakyBucket?
  attempts              PixQueryAttempt[]
  dictOperationAttempts DictOperationAttempt[]
  dictPaymentCredits    DictPaymentCredit[]
  dictEntryLookupTraces DictEntryLookupTrace[]
}

model LeakyBucket {
  id              String   @id @default(uuid())
  tenantId        String   @unique
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  availableTokens Int      @default(10)
  maxTokens       Int      @default(10)
  lastRefillAt    DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PixKey {
  id        String       @id @default(uuid())
  key       String       @unique
  ownerName String
  bankName  String
  status    PixKeyStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
}

model PixQueryAttempt {
  id            String                @id @default(uuid())
  tenantId      String
  tenant        Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pixKey        String
  amount        Decimal               @db.Decimal(14, 2)
  result        PixQueryAttemptResult
  failureReason String?
  tokensBefore  Int
  tokensAfter   Int
  createdAt     DateTime              @default(now())

  @@index([tenantId, createdAt])
}

model DictBucket {
  id            String        @id @default(uuid())
  policyCode    DictPolicyCode
  scopeType     DictScopeType
  scopeKey      String
  tokens        Decimal       @db.Decimal(20, 6)
  lastRefillAt  DateTime
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([policyCode, scopeType, scopeKey])
  @@index([scopeType, scopeKey])
}

model DictOperationAttempt {
  id                 String                    @id @default(uuid())
  tenantId           String
  tenant             Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  operation          DictOperation
  simulatedStatusCode Int
  allowed            Boolean
  httpStatus         Int
  requestPayload     Json
  createdAt          DateTime                  @default(now())
  impacts            DictOperationPolicyImpact[]

  @@index([tenantId, createdAt])
}

model DictOperationPolicyImpact {
  id              String               @id @default(uuid())
  attemptId       String
  attempt         DictOperationAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  policyCode      DictPolicyCode
  scopeType       DictScopeType
  scopeKey        String
  costApplied     Decimal              @db.Decimal(20, 6)
  tokensBefore    Decimal              @db.Decimal(20, 6)
  tokensAfter     Decimal              @db.Decimal(20, 6)
  capacity        Decimal              @db.Decimal(20, 6)
  refillPerSecond Decimal              @db.Decimal(20, 6)
  createdAt       DateTime             @default(now())

  @@index([attemptId])
  @@index([policyCode, scopeType, scopeKey])
}

model DictPaymentCredit {
  id           String      @id @default(uuid())
  tenantId     String
  tenant       Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payerId      String
  keyType      DictKeyType
  endToEndId   String
  impactPayload Json?
  creditedAt   DateTime    @default(now())

  @@unique([tenantId, payerId, keyType, endToEndId])
  @@index([tenantId, payerId, endToEndId])
}

model DictEntryLookupTrace {
  id                String      @id @default(uuid())
  tenantId          String
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payerId           String
  keyType           DictKeyType
  endToEndId        String
  simulatedStatusCode Int
  eligibleForCredit Boolean     @default(false)
  createdAt         DateTime    @default(now())

  @@index([tenantId, payerId, endToEndId])
  @@index([tenantId, payerId, keyType, endToEndId, eligibleForCredit])
}
